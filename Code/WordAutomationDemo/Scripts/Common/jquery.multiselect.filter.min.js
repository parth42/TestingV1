(function(n){var t=/[\-\[\]{}()*+?.,\\\^$|#\s]/g;n.widget("ech.multiselectfilter",{options:{label:"Filter:",width:null,placeholder:"Enter keywords",autoReset:!1},_create:function(){var u,t=this,i=this.options,r=this.instance=n(this.element).data("multiselect");this.header=r.menu.find(".ui-multiselect-header").addClass("ui-multiselect-hasfilter");u=this.wrapper=n('<div class="ui-multiselect-filter">'+(i.label.length?i.label:"")+'<input placeholder="'+i.placeholder+'" type="search"'+(/\d/.test(i.width)?'style="width:'+i.width+'px"':"")+" /><\/div>").prependTo(this.header);i=u;this.inputs=r.menu.find('input[type="checkbox"], input[type="radio"]');this.input=i.find("input").bind({keydown:function(n){13===n.which&&n.preventDefault()},keyup:n.proxy(t._handler,t),click:n.proxy(t._handler,t)});this.updateCache();r._toggleChecked=function(i,r){var u=r&&r.length?r:this.labels.find("input"),e=this,u=u.not(t.instance._isOpen?":disabled, :hidden":":disabled").each(this._toggleState("checked",i)),f;this.update();f=u.map(function(){return this.value}).get();this.element.find("option").filter(function(){!this.disabled&&-1<n.inArray(this.value,f)&&e._toggleState("selected",i).call(this)})};r=n(document).bind("multiselectrefresh",function(){t.updateCache();t._handler()});this.options.autoReset&&r.bind("multiselectclose",n.proxy(this._reset,this))},_handler:function(i){var u=n.trim(this.input[0].value.toLowerCase()),r=this.rows,e=this.inputs,o=this.cache,f;u?(r.hide(),f=RegExp(u.replace(t,"\\$&"),"gi"),this._trigger("filter",i,n.map(o,function(n,t){return-1!==n.search(f)?(r.eq(t).show(),e.get(t)):null}))):r.show();this.instance.menu.find(".ui-multiselect-optgroup-label").each(function(){var t=n(this),i=t.nextUntil(".ui-multiselect-optgroup-label").filter(function(){return"none"!==n.css(this,"display")}).length;t[i?"show":"hide"]()})},_reset:function(){this.input.val("").trigger("keyup")},updateCache:function(){this.rows=this.instance.menu.find(".ui-multiselect-checkboxes li:not(.ui-multiselect-optgroup-label)");this.cache=this.element.children().map(function(){var t=n(this);return"optgroup"===this.tagName.toLowerCase()&&(t=t.children()),t.map(function(){return this.innerHTML.toLowerCase()}).get()}).get()},widget:function(){return this.wrapper},destroy:function(){n.Widget.prototype.destroy.call(this);this.input.val("").trigger("keyup");this.wrapper.remove()}})})(jQuery)